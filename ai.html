<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>&lt;insert game name here&gt;</title>
<script>
/*
TODO:
* HP recovering
* battle system
* items
* FUN!
*/

function dungeonTile(tile, passable, monster) {
  this.tile = tile;
  this.pass = passable;
  this.monster = monster;
}
function monster(id, type, mX, mY, dir) {
	this.id = id;
	this.type = type;
	this.x = mX;
	this.y = mY;
	this.dir = dir;
	this.hp = monsterTypes[type].hp;
	this.attack = monsterTypes[type].attack;
	this.defence = monsterTypes[type].defence;
	this.name = monsterTypes[type].name;
	dungeon[mX][mY].monster = id;
	this.moveTo = function (dir, i, limit) {
		var xOff = new Array(0, 0, 1, 0, -1);
		var yOff = new Array(0, -1, 0, 1, 0);
		if ((dungeon[this.x + xOff[dir]][this.y + yOff[dir]].pass) && !(dungeon[this.x + xOff[dir]][this.y + yOff[dir]].monster)) {
			dungeon[this.x][this.y].monster = 0;
			this.x += xOff[dir];
			this.y += yOff[dir];
			dungeon[this.x][this.y].monster = this.id;
			this.dir = dir;			
		} else if (i < limit) {
			this.moveTo((dir + 1) % 5, i+1, limit);
		}
	}
	this.takeTurn = function () {
		if (Math.abs(this.x - player.x) + Math.abs(this.y - player.y) == 1) {
			attack(this, player); // if player is near, attack him
		} else {
			if ((((this.x - 9) <= player.x) && ((this.x + 9) >= player.x)) && (((this.y - 9) <= player.y) && ((this.y + 9) >= player.y))) { // if can see player, go in his direction
				this.moveTo(player.x == this.x ? (player.y > this.y ? 3 : 1) : (player.x > this.x ? 2 : 4), 1, 4);
				draw();
			} else  { // else go randomly
				this.moveTo(Math.round(Math.random()*3)+1, 1, 4);
				draw();
			}
		}
	}
	this.dead = function () {
		dungeon[this.x][this.y].monster = 0;
	}
}
function monsterType(tile, name, desc, hp, attack, defence) {
	this.tile = tile;
	this.name = name;
	this.desc = desc;
	this.hp = hp;
	this.attack = attack;
	this.defence = defence;
}
function player(name, image, x, y, dir, hp, maxhp, attack, defence) {
	this.name = name;
	this.image = image;
	this.x = x;
	this.y = y;
	this.dir = dir;
	this.hp = hp;
	this.maxHp = maxhp;
	this.attack = attack;
	this.defence = defence;
	this.dead = function () {
		player.hp = 0;
		log("You're dead, GAME OVER");
		gameOver(false);
	}
}

player = new player("Anonymous", "bag", 24, 24, 3, 100, 100, 30, 15);

document.onkeydown = turn;
dungeon = new Array();
for (var i=1; i <= 50; i++) {
  dungeon[i] = new Array();
  for (var j=1; j <= 50; j++) {
    dungeon[i][j] = new dungeonTile((i == 1 || i == 50 || j == 1 || j == 50) ? 2 : 1, (i == 1 || i == 50 || j == 1 || j == 50) ? false : true, 0);
  }
}
dungeon[25][25].tile = 2;
dungeon[25][25].pass = false;

monsterTypes = new Array();
monsterTypes[1] = new monsterType("troll", "Troll", "A normal, fat and green troll.", 10, 20, 20);
monsterTypes[2] = new monsterType("trolltan", "Troll-tan", "She always choses to GTFO.", 10, 20, 20);

monsters = new Array();
monsters[1] = new monster(1, 1, 5, 5, 4);
monsters[2] = new monster(2, 2, 4, 6, 3);
monsters[3] = new monster(3, 1, 5, 7, 1);
mapTiles = new Array();
loaded = 0;

temp = 1;
intervalId = 0;


function log(str) {
	document.getElementById('gamelog').value += str+"\n";
	document.getElementById('gamelog').scrollTop = document.getElementById('gamelog').scrollHeight; 
}

function imgLoad() {
	loaded++;
	if (loaded >= 15) {
		setTimeout(function() {draw(); log(player.name+" has entered the dungeon.");}, 125);
	}
}

function init() {
	document.getElementById('gamelog').value = "";
	canvas = document.getElementById('game');
	if (canvas.getContext){
		ctx = canvas.getContext('2d');
		ctx.font = "16px sans-serif";
		ctx.fillText("Please wait while all the necessary crap is loading...", 100, 210);
		tTerrains = new Array();
		tTerrains[0] = new Image(); // Undefined (black)
		tTerrains[0].src = './images/undefined.png';
		tTerrains[0].onload = imgLoad;
		tTerrains[1] = new Image(); // Floor
		tTerrains[1].src = './images/floor.png';
		tTerrains[1].onload = imgLoad;
		tTerrains[2] = new Image(); // Wall
		tTerrains[2].src = './images/wall.png';
		tTerrains[2].onload = imgLoad;

		
		tPlayer = new Array();    // Player
		tPlayer[1] = new Image(); // Player facing up
		tPlayer[1].src = './images/'+player.image+'/up.png';
		tPlayer[1].onload = imgLoad;
		tPlayer[2] = new Image(); // Player facing right
		tPlayer[2].src = './images/'+player.image+'/right.png';
		tPlayer[2].onload = imgLoad;
		tPlayer[3] = new Image(); // Player facing down
		tPlayer[3].src = './images/'+player.image+'/down.png';
		tPlayer[3].onload = imgLoad;
		tPlayer[4] = new Image(); // Player facing left
		tPlayer[4].src = './images/'+player.image+'/left.png';
		tPlayer[4].onload = imgLoad;	
		
		tMonsters = new Array();
		for (var i = 1; i < monsterTypes.length; i++) {
			tMonsters[i] = new Array();
			tMonsters[i][1] = new Image();
			tMonsters[i][1].src = './images/monsters/'+monsterTypes[i].tile+'_up.png'; 
			tMonsters[i][1].onload = imgLoad;		
			tMonsters[i][2] = new Image();
			tMonsters[i][2].src = './images/monsters/'+monsterTypes[i].tile+'_right.png';
			tMonsters[i][2].onload = imgLoad;		
			tMonsters[i][3] = new Image();
			tMonsters[i][3].src = './images/monsters/'+monsterTypes[i].tile+'_down.png';
			tMonsters[i][3].onload = imgLoad;		
			tMonsters[i][4] = new Image();
			tMonsters[i][4].src = './images/monsters/'+monsterTypes[i].tile+'_left.png';
			tMonsters[i][4].onload = imgLoad;
		}
		mapTiles[1] = ctx.createImageData(3,3); // floor
		for (var i = 0; i <= 35; i++) mapTiles[1].data[i] = !((i+1) % 4) ? 255 : 0;
		mapTiles[2] = ctx.createImageData(3,3); // wall
		for (var i = 0; i <= 35; i++) mapTiles[2].data[i] = 255;
		mapTiles[3] = ctx.createImageData(3,3); // player
		for (var i = 0; i <= 35; i++) mapTiles[3].data[i] = ((i % 2) == 1) ? 255 : 0;
		mapTiles[4] = ctx.createImageData(3,3); // monster
		for (var i = 0; i <= 35; i++) mapTiles[4].data[i] = !(i % 4) || !((i+1) % 4) ? 255 : 0;
	} else {
		alert('you are a baka and youre using an outdated browser');
	}
}

function draw() {
	for (var i = Math.round(player.x)-10; i < 21+(Math.round(player.x)-10); i++) {
		for (var j = Math.round(player.y)-7; j < 15+(Math.round(player.y)-7); j++) {
			ctx.drawImage((dungeon[i] != undefined && dungeon[i][j] != undefined) ? tTerrains[dungeon[i][j].tile] : tTerrains[0], (i-player.x+10)*32, (j-player.y+7)*32);
			if (dungeon[i] != undefined && dungeon[i][j] != undefined && dungeon[i][j].monster) ctx.drawImage(tMonsters[monsters[dungeon[i][j].monster].type][monsters[dungeon[i][j].monster].dir], (i-player.x+10)*32, (j-player.y+7)*32);
		}
	}
	ctx.drawImage(tPlayer[player.dir], 10*32, 7*32);

	ctx.fillStyle = 'gray';
	ctx.fillRect(672, 0, 822, 480);

	ctx.fillStyle = 'white';
	ctx.font = "16px Pixelated";
	ctx.fillText(player.name, 682, 20);
	
	ctx.strokeRect(682, 40, 130, 3);
	ctx.fillStyle = 'green';
	ctx.fillRect(682, 40, (player.hp / player.maxHp)*130, 3);

	ctx.fillStyle = 'white';
	ctx.font = "10px Visitor";
	ctx.fillText(player.hp+"/"+player.maxHp+" HP", 682, 52);
	ctx.fillText("ATT: "+player.attack, 682, 72);
	ctx.fillText("DEF: "+player.defence, 682, 82);
	ctx.fillText("X;Y: "+player.x+";"+player.y, 682, 92);
	
	for (i = 1; i <= 50; i++) {
		for (j = 1; j <= 50; j++) {
			ctx.putImageData(mapTiles[dungeon[i][j].monster ? 4 : (dungeon[i][j].pass ? 1 : 2)], 672+((i-1)*3), 330+((j-1)*3));
		}
	}
	ctx.putImageData(mapTiles[3], 672+((player.x-1)*3), 330+((player.y-1)*3));
	
}

function fillScreenPart() {
	ctx.fillStyle = 'black';  
	ctx.fillRect(0, 0, 672, 10*temp);
	temp++;
	if (temp > 48) {
		clearInterval(intervalId);
		gameOver(true);
	}
}

function gameOver(c) {
	if (!c)	{
		document.onkeydown = "";
		intervalId = setInterval(fillScreenPart, 125);
	} else {
		ctx.fillStyle = 'white';  
		ctx.font = "72px Pixelated";
		ctx.fillText("GAME OVER", 147, 80);
	}
}

function attack(att, def) {
	att.dir = att.x == def.x ? (att.y == def.y+1 ? 1 : 3) : att.x == def.x+1 ? 4 : 2;
	switch (att.dir) {
		case 1: 
			def.dir = 3;
		break; 
		case 2: 
			def.dir = 4;
		break;
		case 3:
			def.dir = 1;
		break;
		case 4:
			def.dir = 2;
		break;
	} 
	draw();
	var success = Math.random() - (def.defence/10 * Math.random());
	if (success > 0.1) {   
		var damage = Math.round(success * att.attack);
		def.hp -= damage;
		log(att.name+' has attacked '+def.name+', and made '+damage+' points of damage.');
	} else {
		log(att.name+' has tried to attack '+def.name+', but missed!');
	}
	if (def.hp < 1) {
		log(def.name+' died.');
		def.dead();
	}
}

function turn(event) {
  var nX = player.x;
  var nY = player.y;
	switch (event.keyCode)
	{
		case 0x25:
			player.dir = 4;
			nX--;
		break;
		case 0x26:
			player.dir = 1;
			nY--;
		break;
		case 0x27:
		  player.dir = 2;
			nX++;
		break;
		case 0x28:
			player.dir = 3;
			nY++;
		break;
		case 0x0D:
		break;
		default:
			nX = -1;
		break;
	}
	
  if (nX != -1 && !event.shiftKey && dungeon[nX][nY].pass) {
		if (dungeon[nX][nY].monster) {
			attack(player, monsters[dungeon[nX][nY].monster]); // player bumped in a monster
		} else {
		  player.x = nX;
		  player.y = nY;
		  
		  player.hp += Math.round(Math.random()*3);
			if (player.hp > player.maxHp) player.hp = player.maxHp;
		}
		
		for (var i = 1; i < monsters.length; i++) {
			if (monsters[i].hp > 0 && player.hp > 0) monsters[i].takeTurn(); // if monster not dead, make him take his turn
		}	// AI players take their turns
		
		draw();
	} else draw();      // player  pressed the wrong key, only wanted to change the direction or bumped in a wall
}
</script>
<style>
@font-face {
	font-family: Pixelated;
	src: url('misc/04b03.otf');
}
@font-face {
	font-family: Visitor;
	src: url('misc/visitor.ttf');
}
#title {
	font-family: Pixelated;
	font-size: 40px;
}
#gamelog {
  background-color: white;
  color: black;
  font-size: 12pt;
  font-family: Pixelated;
  margin-left: 0px;
}
</style>
</head>
<body onLoad='init();'>
<img src='images/logo.png'> <span id='title'>&lt;insert game name here&gt;</span><br /><br />
<canvas id='game' width='822' height='480' style='border-style: solid; border-width: 1px;'>you should have a decent browser (like Firefox 3.5+, or Google Chrome 2.0+) to use this awesome technical demo</canvas><br />
<textarea disabled="disabled" id="gamelog" cols="100" rows="10"></textarea><br />
<input type='button' value='что это, черт возьми, такое?' style='font-family: Pixelated;' onClick='alert("Это — игра в жанре dungeon-crawling roguelike. Пишет её ленивый кодер под ником mariofag в своё свободное время. Арты либо краденные, либо нарисованные няшкой Endou. Пока-что игра находится на зачаточной стадии и в ней реализован лишь базовый функционал. Управление стрелками, что бы повернуться (не совершая ход), надо зажать Shift. Больше информации и связь с разработчиком — в jabber-конференции iichanvg@conference.jabber.ru")' />
<div style='font-family: Visitor; font-size: 10px'>game by mariofag</div>
</body>
</html>